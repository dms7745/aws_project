const express = require('express');
const session = require('express-session');
const mysql = require('mysql2/promise');
const bcrypt = require('bcryptjs');
const path = require('path');

const app = express();
const PORT = 3000;

// MySQL 연결 풀 생성
const pool = mysql.createPool({
    host: 'localhost',
    user: 'web',
    password: 'web123!@#',
    database: 'web',
    waitForConnections: true,
    connectionLimit: 10,
    queueLimit: 0
});

// 미들웨어 설정
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(express.static(path.join(__dirname)));

// 세션 설정
app.use(session({
    secret: 'da2un-secret-key-2025',
    resave: false,
    saveUninitialized: false,
    cookie: {
        secure: false, // HTTPS 사용시 true로 변경
        httpOnly: true,
        maxAge: 1000 * 60 * 60 * 24 // 24시간
    }
}));

// EJS 템플릿 엔진 설정
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));

// 로그인 필요 미들웨어
const requireLogin = (req, res, next) => {
    if (!req.session.userId) {
        return res.redirect('/login');
    }
    next();
};

// 라우트: 로그인 페이지
app.get('/login', (req, res) => {
    if (req.session.userId) {
        return res.redirect('/dashboard');
    }
    res.render('login', { error: null });
});

// 라우트: 로그인 처리
app.post('/login', async (req, res) => {
    const { username, password } = req.body;
    
    if (!username || !password) {
        return res.render('login', { error: '아이디와 비밀번호를 입력해주세요.' });
    }
    
    try {
        const [rows] = await pool.query(
            'SELECT * FROM user WHERE username = ? AND is_active = 1',
            [username]
        );
        
        if (rows.length === 0) {
            return res.json({ success: false, error: '사용자를 찾을 수 없습니다.' });
        }
        
        const user = rows[0];
        const validPassword = await bcrypt.compare(password, user.password);
        
        if (!validPassword) {
            return res.json({ success: false, error: '사용자를 찾을 수 없습니다.' });
        }
        
        // 세션 설정
        req.session.userId = user.id;
        req.session.username = user.username;
        req.session.role = user.role;
        req.session.fullName = user.full_name;
        
        // 마지막 로그인 시간 업데이트
        await pool.query(
            'UPDATE user SET last_login = NOW() WHERE id = ?',
            [user.id]
        );
        
        res.redirect('/dashboard');
    } catch (error) {
        console.error('Login error:', error);
        res.render('login', { error: '로그인 중 오류가 발생했습니다.' });
    }
});

// 라우트: 대시보드
app.get('/dashboard', requireLogin, async (req, res) => {
    try {
        // 현재 사용자 정보 조회
        const [userRows] = await pool.query(
            'SELECT * FROM user WHERE id = ?',
            [req.session.userId]
        );
        
        const currentUser = userRows[0];
        let users = [];
        
        // 관리자인 경우 모든 사용자 조회
        if (currentUser.role === 'admin') {
            const [allUsers] = await pool.query(
                'SELECT id, username, email, full_name, role, is_active, last_login, created_at FROM user ORDER BY created_at DESC'
            );
            users = allUsers;
        }
        
        res.render('dashboard', { currentUser, users });
    } catch (error) {
        console.error('Dashboard error:', error);
        res.status(500).send('서버 오류가 발생했습니다.');
    }
});

// 라우트: 로그아웃
app.get('/logout', (req, res) => {
    req.session.destroy((err) => {
        if (err) {
            console.error('Logout error:', err);
        }
        res.redirect('/login');
    });
});

// 서버 시작
app.listen(PORT, () => {
    console.log(`Server running on http://localhost:${PORT}`);
    console.log('Available routes:');
    console.log('  - GET  /login');
    console.log('  - POST /login');
    console.log('  - GET  /dashboard');
    console.log('  - GET  /logout');
});
