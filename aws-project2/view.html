<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIEW | DAEUN PORTFOLIO</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Pretendard', sans-serif; background-color: #000; color: #fff; }
        .spotlight-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 40%, rgba(0, 80, 180, 0.25) 0%, rgba(0, 0, 0, 1) 75%); z-index: -1; }
        header { position: fixed; top: 0; left: 0; width: 100%; padding: 30px 60px; display: flex; justify-content: space-between; align-items: center; z-index: 1001; }
        .logo { font-size: 20px; font-weight: 800; letter-spacing: 2px; color: #fff; text-decoration: none; text-transform: uppercase; }
        .header-right { display: flex; align-items: center; gap: 20px; }
        .header-link { font-size: 13px; color: rgba(255, 255, 255, 0.6); text-decoration: none; font-weight: 500; text-transform: uppercase; transition: color 0.3s; }
        .header-link:hover { color: #fff; }
        main { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding-top: 100px; }
        .view-container { width: 100%; max-width: 1000px; background: rgba(255, 255, 255, 0.05); padding: 40px; border-radius: 20px; }
        .view-header { border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; margin-bottom: 30px; }
        .view-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 15px; }
        .view-meta { display: flex; gap: 20px; font-size: 0.85rem; color: rgba(255,255,255,0.5); }
        .view-content { min-height: 200px; line-height: 1.8; white-space: pre-wrap; }
        .btn-group { display: flex; justify-content: flex-end; gap: 10px; margin-top: 40px; }
        .btn { padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 600; border: none; text-decoration: none; display: inline-block; text-align: center; }
        .btn-list { background: #333; color: #fff; }
        .btn-edit { background: #0066cc; color: #fff; }
        .btn-delete { background: #ff4d4d; color: #fff; }
        .edit-mode .view-title-input { width: 100%; padding: 15px; font-size: 1.3rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; margin-bottom: 15px; }
        .edit-mode .view-content-input { width: 100%; min-height: 200px; padding: 15px; font-size: 1rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; line-height: 1.8; resize: vertical; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="spotlight-bg"></div>
    <header>
        <a href="/" class="logo">DAEUN PORTFOLIO</a>
        <div class="header-right">
            <a href="/" class="header-link">HOME</a>
            <a href="/board.html" class="header-link">BOARD</a>
            <a href="/mypage.html" id="mypageBtn" class="header-link" style="display:none;">MYPAGE</a>
            <a href="/login.html" id="loginBtn" class="header-link">LOGIN</a>
            <a href="#" id="logoutBtn" class="header-link" style="display:none;">LOGOUT</a>
        </div>
    </header>

    <main>
        <div class="view-container" id="viewContainer">
            <div class="view-header">
                <h2 class="view-title" id="vSubject">Loading...</h2>
                <input type="text" class="view-title-input hidden" id="vSubjectInput">
                <div class="view-meta">
                    <span>작성자: <span id="vAuthor"></span></span>
                    <span>작성일: <span id="vDate"></span></span>
                </div>
            </div>
            <div class="view-content" id="vContent"></div>
            <textarea class="view-content-input hidden" id="vContentInput"></textarea>
            <div class="btn-group" id="viewButtons">
                <a href="board.html" class="btn btn-list">LIST</a>
                <button class="btn btn-edit hidden" id="editBtn" onclick="enableEditMode()">EDIT</button>
                <button class="btn btn-delete hidden" id="deleteBtn" onclick="deletePost()">DELETE</button>
            </div>
            <div class="btn-group hidden" id="editButtons">
                <button class="btn btn-list" onclick="cancelEdit()">CANCEL</button>
                <button class="btn btn-edit" onclick="savePost()">SAVE</button>
            </div>
        </div>
    </main>
    <script>
        var params = new URLSearchParams(window.location.search);
        var postId = params.get('id');
        var currentPost = null;
        var allPosts = [];
        var postsPerPage = 10;
        var currentUser = null;
        var ADMIN_ID = 'a1'; // 관리자 아이디

        window.onload = function() {
            // 로그인 상태 체크
            var userStr = localStorage.getItem('user');
            if (userStr) {
                currentUser = JSON.parse(userStr);
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('mypageBtn').style.display = 'inline-block';
                document.getElementById('logoutBtn').style.display = 'inline-block';
            }

            document.getElementById('logoutBtn').onclick = function() {
                localStorage.removeItem('user');
                location.reload();
            };

            if (!postId) {
                alert('잘못된 접근입니다.');
                location.href = '/board.html';
                return;
            }
            
            fetch('/api/posts')
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    allPosts = data.posts || [];
                    return fetch('/api/posts/' + postId);
                })
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    if (data.success && data.post) {
                        currentPost = data.post;
                        document.getElementById('vSubject').innerText = data.post.subject;
                        document.getElementById('vAuthor').innerText = data.post.name;
                        document.getElementById('vDate').innerText = data.post.date;
                        document.getElementById('vContent').innerText = data.post.content;
                        
                        // 작성자 또는 관리자만 수정/삭제 버튼 표시
                        if (currentUser) {
                            var isAuthor = currentUser.userId === data.post.authorId;
                            var isAdmin = currentUser.userId === ADMIN_ID;
                            if (isAuthor || isAdmin) {
                                document.getElementById('editBtn').classList.remove('hidden');
                                document.getElementById('deleteBtn').classList.remove('hidden');
                            }
                        }
                    } else {
                        alert('게시글을 찾을 수 없습니다.');
                        location.href = '/board.html';
                    }
                })
                .catch(function(err) {
                    console.error('Error:', err);
                    alert('데이터를 불러오지 못했습니다.');
                });
        };

        function getPageForPost(postId) {
            for (var i = 0; i < allPosts.length; i++) {
                if (allPosts[i].id === parseInt(postId)) {
                    return Math.floor(i / postsPerPage) + 1;
                }
            }
            return 1;
        }

        function goToListWithPage() {
            var page = getPageForPost(postId);
            location.href = '/board.html?page=' + page;
        }

        function enableEditMode() {
            document.getElementById('viewContainer').classList.add('edit-mode');
            document.getElementById('vSubject').classList.add('hidden');
            document.getElementById('vSubjectInput').classList.remove('hidden');
            document.getElementById('vSubjectInput').value = currentPost.subject;
            document.getElementById('vContent').classList.add('hidden');
            document.getElementById('vContentInput').classList.remove('hidden');
            document.getElementById('vContentInput').value = currentPost.content;
            document.getElementById('viewButtons').classList.add('hidden');
            document.getElementById('editButtons').classList.remove('hidden');
        }

        function cancelEdit() {
            document.getElementById('viewContainer').classList.remove('edit-mode');
            document.getElementById('vSubject').classList.remove('hidden');
            document.getElementById('vSubjectInput').classList.add('hidden');
            document.getElementById('vContent').classList.remove('hidden');
            document.getElementById('vContentInput').classList.add('hidden');
            document.getElementById('viewButtons').classList.remove('hidden');
            document.getElementById('editButtons').classList.add('hidden');
        }

        function savePost() {
            var newSubject = document.getElementById('vSubjectInput').value;
            var newContent = document.getElementById('vContentInput').value;
            
            if (!newSubject || !newContent) {
                alert('제목과 내용을 입력해주세요.');
                return;
            }
            
            fetch('/api/posts/' + postId, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ subject: newSubject, content: newContent })
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.success) {
                    alert('수정되었습니다.');
                    goToListWithPage();
                } else {
                    alert('수정 실패: ' + data.message);
                }
            })
            .catch(function(err) {
                console.error('Error:', err);
                alert('서버 연결 오류가 발생했습니다.');
            });
        }

        function deletePost() {
            if (confirm('정말로 삭제하시겠습니까?')) {
                fetch('/api/posts/' + postId, { method: 'DELETE' })
                    .then(function(res) { return res.json(); })
                    .then(function(data) {
                        if (data.success) {
                            alert('삭제되었습니다.');
                            location.href = '/board.html';
                        } else {
                            alert('삭제 실패: ' + data.message);
                        }
                    })
                    .catch(function(err) { alert('서버 연결 오류가 발생했습니다.'); });
            }
        }
    </script>
</body>
</html>
